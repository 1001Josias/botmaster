#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üß™ Running pre-push validations..."

# Run tests only on affected workspaces
echo "Running tests on affected workspaces..."
pnpm test:affected || {
  echo "‚ùå Tests failed on affected workspaces"
  exit 1
}

# Security scan
echo "Running security scan..."
pnpm security:scan || {
  echo "‚ö†Ô∏è  Security scan found issues, but allowing push"
}

# Bundle size analysis (if applicable)
echo "Running bundle analysis..."
pnpm bundle:analyze || {
  echo "‚ö†Ô∏è  Bundle analysis failed, but allowing push"
}

# Remove the current worktree if not in the main repository directory
if [ -f .git ] && grep -q "gitdir: ../.git/worktrees/" .git; then
  branch=$(git rev-parse --abbrev-ref HEAD)
  git worktree remove .
  echo "Worktree removed for branch $branch"
fi

echo "‚úÖ Pre-push validations completed successfully"
