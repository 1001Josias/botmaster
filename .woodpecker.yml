steps:
  build-image:
    image: docker:latest
    commands:
      - docker build -t local-pnpm-image:latest -f Dockerfile.pnpm .
    when:
      event: [ pull_request, push ]

  install-dependencies:
    image: local-pnpm-image:latest
    commands:
      - pnpm i
    depends_on:
      - build-image
    when:
      event: [ pull_request, push ]

  bundle-analyze:
    image: local-pnpm-image:latest
    commands:
      - pnpm run bundle:analyze
    depends_on:
      - install-dependencies
    when:
      event: [ pull_request, push ]

  lint:
    image: local-pnpm-image:latest
    commands:
      - pnpm lint
    depends_on:
      - install-dependencies
    when:
      event: [ pull_request, push ]

  format-check:
    image: local-pnpm-image:latest
    commands:
      - pnpm format:check
    depends_on:
      - install-dependencies
    when:
      event: [ pull_request, push ]

  security-scan:
    image: local-pnpm-image:latest
    commands:
      - pnpm audit
    depends_on:
      - install-dependencies
    when:
      event: [ pull_request, push ]

  test:
    image: local-pnpm-image:latest
    commands:
      - pnpm test
    depends_on:
      - install-dependencies
    when:
      event: [ pull_request, push ]

  test-affected:
    image: local-pnpm-image:latest
    commands:
      - pnpm test:affected
    depends_on:
      - install-dependencies
    when:
      event: [ pull_request, push ]

  test-coverage:
    image: local-pnpm-image:latest
    commands:
      - pnpm test:coverage
    depends_on:
      - install-dependencies
    when:
      event: [ pull_request, push ]